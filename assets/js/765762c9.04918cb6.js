(window.webpackJsonp=window.webpackJsonp||[]).push([[63],{123:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return i})),n.d(t,"metadata",(function(){return p})),n.d(t,"toc",(function(){return s})),n.d(t,"default",(function(){return u}));var o=n(1),a=n(8),r=(n(0),n(250)),l=["components"],i={title:"Network layer (Apollo Link)",description:"How to configure Apollo Client's network layer."},p={unversionedId:"basics/network-layer",id:"version-1.0/basics/network-layer",isDocsHomePage:!1,title:"Network layer (Apollo Link)",description:"How to configure Apollo Client's network layer.",source:"@site/versioned_docs/version-1.0/basics/network-layer.md",slug:"/basics/network-layer",permalink:"/docs/1.0/basics/network-layer",editUrl:"https://github.com/kamilkisiela/apollo-angular/edit/master/website/versioned_docs/version-1.0/basics/network-layer.md",version:"1.0",sidebar:"version-1.0/docs",previous:{title:"Query, Mutation, Subscription services",permalink:"/docs/1.0/basics/services"},next:{title:"Apollo Cache",permalink:"/docs/1.0/basics/caching"}},s=[{value:"Apollo Link",id:"apollo-link",children:[{value:"Using an link",id:"using-an-link",children:[]},{value:"Middleware",id:"middleware",children:[]},{value:"Afterware",id:"afterware",children:[]},{value:"Query deduplication",id:"query-deduplication",children:[]}]},{value:"Other links",id:"other-links",children:[{value:"GraphQL over WebSocket",id:"graphql-over-websocket",children:[]},{value:"Query Batching",id:"query-batching",children:[]}]}],c={toc:s};function u(e){var t=e.components,n=Object(a.a)(e,l);return Object(r.b)("wrapper",Object(o.a)({},c,n,{components:t,mdxType:"MDXLayout"}),Object(r.b)("p",null,"Now that you have learned how to read and update your data, its helpful to know how to direct where your data comes from and where it goes! Apollo has a powerful way to manage your network layer using a library called ",Object(r.b)("a",{parentName:"p",href:"https://www.apollographql.com/docs/link"},"Apollo Link"),";"),Object(r.b)("h2",{id:"apollo-link"},"Apollo Link"),Object(r.b)("p",null,"Apollo Client has a pluggable network interface layer, which can let you configure how queries are sent over HTTP, or replace the whole network part with something completely custom, like a websocket transport, mocked server data, or anything else you can imagine."),Object(r.b)("h3",{id:"using-an-link"},"Using an link"),Object(r.b)("p",null,"To create a link to use with Apollo Client, you can install and import one from npm or create your own. We recommend using ",Object(r.b)("inlineCode",{parentName:"p"},"apollo-angular-link-http")," for most setups!"),Object(r.b)("p",null,"First, you need to import Module for each package:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-ts"},"import { ApolloModule } from 'apollo-angular';\nimport { HttpLinkModule } from 'apollo-angular-link-http';\n\n@NgModule({\n  imports: [\n    ApolloModule,\n    HttpLinkModule\n  ]\n})\nclass AppModule {}\n")),Object(r.b)("p",null,"Since ",Object(r.b)("inlineCode",{parentName:"p"},"HttpLink")," uses Angular's ",Object(r.b)("inlineCode",{parentName:"p"},"HttpClient")," (",Object(r.b)("inlineCode",{parentName:"p"},"@angular/common/http"),") internally so it is possible to use it in ",Object(r.b)("inlineCode",{parentName:"p"},"NativeScript")," or in combination with any other HttpClient provider."),Object(r.b)("p",null,"Since the example runs in browser, we are going to use ",Object(r.b)("inlineCode",{parentName:"p"},"HttpClientModule")," from ",Object(r.b)("inlineCode",{parentName:"p"},"@angular/common/http")," package."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-ts"},"import { HttpClientModule } from '@angular/common/http';\nimport { ApolloModule } from 'apollo-angular';\nimport { HttpLinkModule } from 'apollo-angular-link-http';\n\n@NgModule({\n  imports: [\n    HttpClientModule,\n    ApolloModule,\n    HttpLinkModule\n  ]\n})\nclass AppModule {}\n")),Object(r.b)("p",null,"Since Angular has now access to Apollo related services, here's how you would instantiate a new client with a custom endpoint URL using the HttpLink:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-ts"},"import { HttpClientModule } from '@angular/common/http';\nimport { ApolloModule, Apollo } from 'apollo-angular';\nimport { HttpLinkModule, HttpLink } from 'apollo-angular-link-http';\n\n@NgModule({\n  imports: [\n    HttpClientModule,\n    ApolloModule,\n    HttpLinkModule\n  ]\n})\nclass AppModule {\n  constructor(\n    apollo: Apollo,\n    httpLink: HttpLink\n  ) {\n    const link = httpLink.create({ uri: 'https://example.com/graphql' });\n\n    apollo.create({\n      link,\n      // other options like cache\n    });\n  }\n}\n")),Object(r.b)("p",null,"And if you needed to pass additional options to ",Object(r.b)("a",{parentName:"p",href:"https://angular.io/api/common/http/HttpClient"},Object(r.b)("inlineCode",{parentName:"a"},"HttpClient")),":"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-ts"},"import { Apollo } from 'apollo-angular';\nimport { HttpLink } from 'apollo-angular-link-http';\n\n@NgModule({ ... })\nclass AppModule {\n  constructor(\n    apollo: Apollo,\n    httpLink: HttpLink\n  ) {\n    const link = httpLink.create({\n      uri: 'https://example.com/graphql',\n      withCredentials: true,\n      method: 'GET'\n    });\n\n    apollo.create({\n      link,\n      // other options like cache\n    });\n  }\n}\n")),Object(r.b)("h3",{id:"middleware"},"Middleware"),Object(r.b)("p",null,"Apollo Link is designed from day one to be easy to use middleware on your requests. Middlewares are used to inspect and modify every request made over the ",Object(r.b)("inlineCode",{parentName:"p"},"link"),", for example, adding authentication tokens to every query. In order to add middleware, you simply create a new link and join it with the ",Object(r.b)("inlineCode",{parentName:"p"},"HttpLink"),"."),Object(r.b)("p",null,"The following examples shows how you'd create a middleware. In both examples, we'll show how you would add an authentication token to the HTTP header of the requests being sent by the client."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-js"},"import { Apollo } from 'apollo-angular';\nimport { HttpLink } from 'apollo-angular-link-http';\nimport { ApolloLink, concat } from 'apollo-link';\nimport { HttpHeaders } from '@angular/common/http';\n\n@NgModule({ ... })\nclass AppModule {\n  constructor(\n    apollo: Apollo,\n    httpLink: HttpLink\n  ) {\n    const http = httpLink.create({ uri: '/graphql' });\n\n    const authMiddleware = new ApolloLink((operation, forward) => {\n      // add the authorization to the headers\n      operation.setContext({\n        headers: new HttpHeaders().set('Authorization', localStorage.getItem('token') || null)\n      });\n\n      return forward(operation);\n    });\n\n    apollo.create({\n      link: concat(authMiddleware, http),\n    });\n  }\n}\n\n")),Object(r.b)("p",null,"The above example shows the use of a single middleware joined with the HttpLink. It checks to see if we have a token (JWT, for example) and passes that token into the HTTP header of the request, so we can authenticate interactions with GraphQL performed through our network interface."),Object(r.b)("p",null,"The following example shows the use of multiple middlewares passed as an array:"),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-ts"},"import { Apollo } from 'apollo-angular';\nimport { HttpLink } from 'apollo-angular-link-http';\nimport { ApolloLink } from 'apollo-link';\n\n@NgModule({ ... })\nclass AppModule {\n  constructor(\n    apollo: Apollo,\n    httpLink: HttpLink\n  ) {\n    const http = httpLink.create({ uri: '/graphql' });\n\n    const authMiddleware = new ApolloLink((operation, forward) => {\n      // add the authorization to the headers\n      // we assume `headers` as a defined instance of HttpHeaders\n      operation.setContext(({ headers }) => ({\n        headers: headers.append('Authorization', localStorage.getItem('token') || null),\n      }));\n\n      return forward(operation);\n    })\n\n    const otherMiddleware = new ApolloLink((operation, forward) => {\n      // add the authorization to the headers\n      // we assume `headers` as a defined instance of HttpHeaders\n      operation.setContext(({ headers }) => ({\n        headers: headers.append('recent-activity', localStorage.getItem('lastOnlineTime') || null)\n      }));\n\n      return forward(operation);\n    })\n\n    apollo.create({\n      link: ApolloLink.from([authMiddleware, otherMiddleware, http]),\n    });\n  }\n}\n")),Object(r.b)("p",null,"Given the above code, the header's ",Object(r.b)("inlineCode",{parentName:"p"},"Authorization")," value will be that of ",Object(r.b)("inlineCode",{parentName:"p"},"token")," and the ",Object(r.b)("inlineCode",{parentName:"p"},"recent-activity")," value will be that of ",Object(r.b)("inlineCode",{parentName:"p"},"lastOnlineTime"),". This example shows how you can use more than one middleware to make multiple/separate modifications to the request being processed in the form of a chain.  This example doesn't show the use of ",Object(r.b)("inlineCode",{parentName:"p"},"localStorage"),", but is instead just meant to demonstrate the use of more than one middleware using Apollo Link."),Object(r.b)("h3",{id:"afterware"},"Afterware"),Object(r.b)("p",null,"'Afterware' is very similar to a middleware, except that an afterware runs after a request has been made,\nthat is when a response is going to get processed. It's perfect for responding to the situation where a user becomes logged out during their session."),Object(r.b)("p",null,"Much like middlewares, Apollo Link was designed to make afterwares easy and powerful to use with Apollo!"),Object(r.b)("p",null,"The following example demonstrates how to implement an afterware function."),Object(r.b)("pre",null,Object(r.b)("code",{parentName:"pre",className:"language-ts"},"import { Apollo } from 'apollo-angular';\nimport { HttpLink } from 'apollo-angular-link-http';\nimport { onError } from 'apollo-link-error'\n\nimport { Auth } from './auth';\n\n@NgModule({ ... })\nclass AppModule {\n  constructor(\n    apollo: Apollo,\n    httpLink: HttpLink,\n    auth: Auth\n  ) {\n    const http = httpLink.create({ uri: '/graphql' });\n\n    const logoutLink = onError(({ networkError }) => {\n      if (networkError.statusCode === 401) auth.logout();\n    });\n\n    apollo.create({\n      link: logoutLink.concat(http),\n    });\n  }\n}\n")),Object(r.b)("p",null,"The above example shows the use of ",Object(r.b)("inlineCode",{parentName:"p"},"apollo-link-error")," to handle network errors from a response.\nIt checks to see if the response status code is equal to 401 and if it is then we will\nlogout the user from the application."),Object(r.b)("h3",{id:"query-deduplication"},"Query deduplication"),Object(r.b)("p",null,"Query deduplication can help reduce the number of queries that are sent over the wire. It is turned on by default, but can be turned off by passing ",Object(r.b)("inlineCode",{parentName:"p"},"queryDeduplication: false")," to the context on each requests or using the ",Object(r.b)("inlineCode",{parentName:"p"},"defaultOptions")," key on Apollo Client setup. If turned on, query deduplication happens before the query hits the network layer."),Object(r.b)("p",null," Query deduplication can be useful if many components display the same data, but you don't want to fetch that data from the server many times. It works by comparing a query to all queries currently in flight. If an identical query is currently in flight, the new query will be mapped to the same promise and resolved when the currently in-flight query returns."),Object(r.b)("h2",{id:"other-links"},"Other links"),Object(r.b)("p",null,"The network stack of Apollo Client is easily customized using Apollo Link! It can log errors, send side effects, send data over WebSockets or HTTP, and so much more. A few examples are below but make sure to check out the ",Object(r.b)("a",{parentName:"p",href:"https://www.apollographql.com/docs/link"},"link docs")," to learn more!"),Object(r.b)("h3",{id:"graphql-over-websocket"},"GraphQL over WebSocket"),Object(r.b)("p",null,"Another alternative for network interface is GraphQL over WebSocket, using ",Object(r.b)("a",{parentName:"p",href:"https://github.com/apollographql/subscriptions-transport-ws/"},Object(r.b)("inlineCode",{parentName:"a"},"subscriptions-transport-ws")),"."),Object(r.b)("p",null,"You can the create WebSocket as full-transport, and pass all GraphQL operations over the WebSocket (",Object(r.b)("inlineCode",{parentName:"p"},"Query"),", ",Object(r.b)("inlineCode",{parentName:"p"},"Mutation")," and ",Object(r.b)("inlineCode",{parentName:"p"},"Subscription"),"), or use a hybrid network interface and execute ",Object(r.b)("inlineCode",{parentName:"p"},"Query")," and ",Object(r.b)("inlineCode",{parentName:"p"},"Mutation")," over HTTP, and only ",Object(r.b)("inlineCode",{parentName:"p"},"Subscription")," over the WebSocket."),Object(r.b)("p",null,"For more information about using WebSocket's with Apollo Link, check out the ",Object(r.b)("a",{parentName:"p",href:"https://www.apollographql.com/docs/link/links/ws/"},"indepth guide")),Object(r.b)("h3",{id:"query-batching"},"Query Batching"),Object(r.b)("p",null,"Apollo lets you automatically batch multiple queries into one request when they are made within a certain interval. This means that if you render several components, for example a navbar, sidebar, and content, and each of those do their own GraphQL query, they will all be sent in one roundtrip. Batching works only with servers that support batched queries (for example graphql-server). Batched requests to servers that don\u2019t support batching will fail. To learn how to use batching with Apollo checkout the ",Object(r.b)("a",{parentName:"p",href:"https://github.com/kamilkisiela/apollo-angular/tree/master/packages/apollo-angular-link-http-batch"},"indepth guide")))}u.isMDXComponent=!0},250:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return b}));var o=n(0),a=n.n(o);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?l(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):l(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function p(e,t){if(null==e)return{};var n,o,a=function(e,t){if(null==e)return{};var n,o,a={},r=Object.keys(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(o=0;o<r.length;o++)n=r[o],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=a.a.createContext({}),c=function(e){var t=a.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=c(e.components);return a.a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},h=a.a.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,s=p(e,["components","mdxType","originalType","parentName"]),u=c(n),h=o,b=u["".concat(l,".").concat(h)]||u[h]||d[h]||r;return n?a.a.createElement(b,i(i({ref:t},s),{},{components:n})):a.a.createElement(b,i({ref:t},s))}));function b(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,l=new Array(r);l[0]=h;var i={};for(var p in t)hasOwnProperty.call(t,p)&&(i[p]=t[p]);i.originalType=e,i.mdxType="string"==typeof e?e:o,l[1]=i;for(var s=2;s<r;s++)l[s]=n[s];return a.a.createElement.apply(null,l)}return a.a.createElement.apply(null,n)}h.displayName="MDXCreateElement"}}]);